{% extends 'base.html' %}

{% block title %}Dues Scanner - Hack@UCF{% endblock %}

{% block head %}
<!-- QR library - ZXing -->
<script src="/static/lib/zxing.min.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    background: #000;
    color: white;
    overflow: hidden;
    height: 100vh;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .scanner-container {
    position: relative;
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
    transition: background-color 0.3s ease;
    cursor: pointer;
    touch-action: manipulation;
  }

  .scanner-container.success {
    background: #4CAF50;
  }

  .scanner-container.error {
    background: #f44336;
  }

  .scanner-content {
    text-align: center;
    position: relative;
    z-index: 10;
  }

  video {
    width: 100%;
    max-width: 400px;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  }

  .subtitle {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    opacity: 0.9;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .status-message {
    font-size: 3rem;
    font-weight: 900;
    margin-top: 2rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .status-message.show {
    opacity: 1;
  }

  .clear-instruction {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .clear-instruction.show {
    opacity: 0.7;
  }

  .camera-controls {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 20;
  }

  .camera-button {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .camera-button:hover {
    background: rgba(0, 0, 0, 0.9);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
  }

  .camera-button:active {
    transform: translateY(0);
  }

  @media (max-width: 768px) {
    .title {
      font-size: 2rem;
    }
    
    .subtitle {
      font-size: 1rem;
    }
    
    .status-message {
      font-size: 2rem;
      letter-spacing: 2px;
    }
    
    video {
      max-width: 300px;
    }
  }

  footer {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="scanner-container" id="scannerContainer">
  <div class="camera-controls">
    <button class="camera-button" id="changeCameraBtn">
      ðŸ“· Switch Camera
    </button>
  </div>
  <div class="scanner-content">
    <h1 class="title">Hack@UCF Dues Scanner</h1>
    <p class="subtitle">Point camera at member QR code</p>
    <video id="qr-video" autoplay></video>
    <div class="status-message" id="statusMessage"></div>
  </div>
  <div class="clear-instruction" id="clearInstruction">
    Touch anywhere to scan again
  </div>
</div>

<script>
let codeReader;
let isScanning = true;
let currentDeviceId = null;

// Initialize QR Scanner
async function initScanner() {
  const video = document.getElementById('qr-video');
  
  try {
    // Create ZXing code reader
    codeReader = new ZXing.BrowserQRCodeReader();
    
    // Check for saved camera preference
    const savedCamera = localStorage.getItem("scannerCam");
    if (savedCamera && savedCamera !== "undefined") {
      currentDeviceId = savedCamera;
    } else {
      // Get default camera (prefer back camera)
      const devices = await codeReader.listVideoInputDevices();
      if (devices.length > 0) {
        // Try to find back camera
        const backCamera = devices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('environment')
        );
        currentDeviceId = backCamera ? backCamera.deviceId : devices[0].deviceId;
      }
    }
    
    // Start decoding
    codeReader.decodeFromVideoDevice(currentDeviceId, video, (result, error) => {
      if (result && isScanning) {
        onScanResult(result);
      }
      if (error && error.name !== 'NotFoundException') {
        console.error('Decode error:', error);
      }
    });
  } catch (err) {
    console.error('Error starting scanner:', err);
    showError('Camera Error', 'Unable to access camera');
  }
}

// Handle scan result
async function onScanResult(result) {
  if (!isScanning) return;
  
  console.log('Scanned:', result.text);
  stopScanner();
  isScanning = false;
  
  try {
    // Call API to check dues status
    const response = await fetch(`/api/member/${result.text}/dues`);
    const data = await response.json();
    
    if (data.dues) {
      showSuccess();
    } else {
      showError();
    }
  } catch (error) {
    console.error('Error checking dues:', error);
    showError();
  }
}

// Stop scanner
function stopScanner() {
  if (codeReader) {
    codeReader.reset();
  }
}

// Show success (green)
function showSuccess() {
  const container = document.getElementById('scannerContainer');
  const statusMessage = document.getElementById('statusMessage');
  const clearInstruction = document.getElementById('clearInstruction');
  
  container.className = 'scanner-container success';
  statusMessage.textContent = 'Dues Paid âœ“';
  statusMessage.classList.add('show');
  clearInstruction.classList.add('show');
}

// Show error (red)
function showError(title = 'Dues Not Paid âœ—', subtitle = '') {
  const container = document.getElementById('scannerContainer');
  const statusMessage = document.getElementById('statusMessage');
  const clearInstruction = document.getElementById('clearInstruction');
  
  container.className = 'scanner-container error';
  statusMessage.textContent = title;
  statusMessage.classList.add('show');
  clearInstruction.classList.add('show');
}

// Clear and restart scanning
function clearAndRestart() {
  if (isScanning) return; // Already scanning
  
  const container = document.getElementById('scannerContainer');
  const statusMessage = document.getElementById('statusMessage');
  const clearInstruction = document.getElementById('clearInstruction');
  
  // Reset UI
  container.className = 'scanner-container';
  statusMessage.classList.remove('show');
  clearInstruction.classList.remove('show');
  
  // Restart scanner
  setTimeout(() => {
    isScanning = true;
    initScanner();
  }, 300);
}

// Switch camera functionality
async function switchCamera() {
  try {
    const cameras = await codeReader.listVideoInputDevices();
    
    if (cameras.length <= 1) {
      alert('Only one camera available');
      return;
    }
    
    let cameraOptions = 'Select a camera:\n\n';
    cameras.forEach((camera, index) => {
      cameraOptions += `${index}: ${camera.label || `Camera ${index + 1}`}\n`;
    });
    
    const selection = prompt(cameraOptions + '\nEnter camera number:');
    
    if (selection !== null && selection !== '') {
      const cameraIndex = parseInt(selection);
      
      if (cameraIndex >= 0 && cameraIndex < cameras.length) {
        const selectedCameraId = cameras[cameraIndex].deviceId;
        
        // Save camera preference
        localStorage.setItem("scannerCam", selectedCameraId);
        currentDeviceId = selectedCameraId;
        
        // Restart scanner with new camera
        stopScanner();
        const video = document.getElementById('qr-video');
        codeReader.decodeFromVideoDevice(currentDeviceId, video, (result, error) => {
          if (result && isScanning) {
            onScanResult(result);
          }
          if (error && error.name !== 'NotFoundException') {
            console.error('Decode error:', error);
          }
        });
        
        console.log(`Switched to camera: ${cameras[cameraIndex].label || `Camera ${cameraIndex + 1}`}`);
      } else {
        alert('Invalid camera number');
      }
    }
  } catch (error) {
    console.error('Error switching camera:', error);
    alert('Error switching camera. Make sure you have multiple cameras available.');
  }
}

// Touch/click handler for clearing status
document.getElementById('scannerContainer').addEventListener('click', function(e) {
  // Don't trigger clear if clicking the camera button
  if (e.target.id === 'changeCameraBtn') {
    return;
  }
  e.preventDefault();
  clearAndRestart();
});

// Camera switch button handler
document.getElementById('changeCameraBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  switchCamera();
});

// Prevent context menu on long press
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
});

// Initialize when page loads
window.addEventListener('load', function() {
  initScanner();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  stopScanner();
});
</script>
{% endblock %}

{% block footer %}{% endblock %}