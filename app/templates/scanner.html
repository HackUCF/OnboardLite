{% extends 'base.html' %}

{% block title %}Dues Scanner - Hack@UCF{% endblock %}

{% block head %}
<!-- QR library -->
<script src="/static/lib/qr-scanner.umd.min.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    background: #000;
    color: white;
    overflow: hidden;
    height: 100vh;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .scanner-container {
    position: relative;
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
    transition: background-color 0.3s ease;
    cursor: pointer;
    touch-action: manipulation;
  }

  .scanner-container.success {
    background: #4CAF50;
  }

  .scanner-container.error {
    background: #f44336;
  }

  .scanner-content {
    text-align: center;
    position: relative;
    z-index: 10;
  }

  video {
    width: 100%;
    max-width: 400px;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  }

  .subtitle {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    opacity: 0.9;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .status-message {
    font-size: 3rem;
    font-weight: 900;
    margin-top: 2rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .status-message.show {
    opacity: 1;
  }

  .clear-instruction {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  }

  .clear-instruction.show {
    opacity: 0.7;
  }

  @media (max-width: 768px) {
    .title {
      font-size: 2rem;
    }
    
    .subtitle {
      font-size: 1rem;
    }
    
    .status-message {
      font-size: 2rem;
      letter-spacing: 2px;
    }
    
    video {
      max-width: 300px;
    }
  }

  footer {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="scanner-container" id="scannerContainer">
  <div class="scanner-content">
    <h1 class="title">Hack@UCF Dues Scanner</h1>
    <p class="subtitle">Point camera at member QR code</p>
    <video id="qr-video" autoplay></video>
    <div class="status-message" id="statusMessage"></div>
  </div>
  <div class="clear-instruction" id="clearInstruction">
    Touch anywhere to scan again
  </div>
</div>

<script>
let qrScanner;
let isScanning = true;

// Initialize QR Scanner
function initScanner() {
  const video = document.getElementById('qr-video');
  qrScanner = new QrScanner(video, onScanResult, {
    maxScansPerSecond: 5,
    highlightScanRegion: true,
    returnDetailedScanResult: true,
  });
  
  qrScanner.start().catch(err => {
    console.error('Error starting scanner:', err);
    showError('Camera Error', 'Unable to access camera');
  });
}

// Handle scan result
async function onScanResult(result) {
  if (!isScanning) return;
  
  console.log('Scanned:', result.data);
  qrScanner.stop();
  isScanning = false;
  
  try {
    // Call API to check dues status
    const response = await fetch(`/api/member/${result.data}/dues`);
    const data = await response.json();
    
    if (data.dues) {
      showSuccess();
    } else {
      showError();
    }
  } catch (error) {
    console.error('Error checking dues:', error);
    showError();
  }
}

// Show success (green)
function showSuccess() {
  const container = document.getElementById('scannerContainer');
  const statusMessage = document.getElementById('statusMessage');
  const clearInstruction = document.getElementById('clearInstruction');
  
  container.className = 'scanner-container success';
  statusMessage.textContent = 'Dues Paid ✓';
  statusMessage.classList.add('show');
  clearInstruction.classList.add('show');
}

// Show error (red)
function showError(title = 'Dues Not Paid ✗', subtitle = '') {
  const container = document.getElementById('scannerContainer');
  const statusMessage = document.getElementById('statusMessage');
  const clearInstruction = document.getElementById('clearInstruction');
  
  container.className = 'scanner-container error';
  statusMessage.textContent = title;
  statusMessage.classList.add('show');
  clearInstruction.classList.add('show');
}

// Clear and restart scanning
function clearAndRestart() {
  if (isScanning) return; // Already scanning
  
  const container = document.getElementById('scannerContainer');
  const statusMessage = document.getElementById('statusMessage');
  const clearInstruction = document.getElementById('clearInstruction');
  
  // Reset UI
  container.className = 'scanner-container';
  statusMessage.classList.remove('show');
  clearInstruction.classList.remove('show');
  
  // Restart scanner
  setTimeout(() => {
    isScanning = true;
    qrScanner.start().catch(err => {
      console.error('Error restarting scanner:', err);
    });
  }, 300);
}

// Touch/click handler
document.getElementById('scannerContainer').addEventListener('click', function(e) {
  e.preventDefault();
  clearAndRestart();
});

// Prevent context menu on long press
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
});

// Initialize when page loads
window.addEventListener('load', function() {
  initScanner();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  if (qrScanner) {
    qrScanner.destroy();
  }
});
</script>
{% endblock %}

{% block footer %}{% endblock %}